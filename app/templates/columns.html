{% extends "base.html" %}

{% block title %}Column Operations{% endblock %}

{% block head_content %}
    <style>
        .columns-layout { display: flex; height: 100%; overflow: hidden; }

        /* --- Left Sidebar (Operations Panel) --- */
        .operations-sidebar {
            width: 320px;
            flex-shrink: 0;
            background-color: #161220;
            border-right: 1px solid #2C2541;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Sidebar Top: Structure Operations */
        .sidebar-top {
            flex-shrink: 0;
            padding: 20px;
            border-bottom: 1px solid #2C2541;
        }
        .sidebar-top h4 { margin: 0 0 15px 0; color: #FFFFFF; }
        .structure-ops { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .op-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 8px; padding: 15px 10px; background-color: #2C2541; border: 1px solid #4a3f6e;
            color: #a095c0; border-radius: 8px; cursor: pointer; transition: all 0.2s;
            font-size: 12px; font-weight: 500;
        }
        .op-btn:hover { background-color: #4a3f6e; color: #FFFFFF; }
        .op-btn.active { background-color: #9D4EDD; color: white; border-color: #9D4EDD; }
        .op-btn svg { width: 24px; height: 24px; }

        /* Sidebar Bottom: Operation Controls */
        .sidebar-bottom {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 0;
        }
        .sidebar-bottom h4 { margin: 0 0 15px 0; color: #FFFFFF; }

        /* --- Main Content (Table) --- */
        .columns-main { flex-grow: 1; display: flex; flex-direction: column; padding: 20px; overflow: hidden; }
        .operation-header { flex-shrink: 0; margin-bottom: 20px; }
        .operation-header h2 { margin: 0; color: #FFFFFF; }
        .operation-header p { color: #a095c0; margin: 5px 0 0 0; }
        
        /* Operation Controls (now in sidebar) */
        .control-group { margin-bottom: 20px; }
        .control-group label { font-size: 12px; font-weight: 500; color: #a095c0; display: block; margin-bottom: 8px; }
        .control-group select, .control-group input {
            width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #4a3f6e;
            background-color: #2C2541; color: #E0D9F0; box-sizing: border-box;
        }
        .apply-op-btn {
            width: 100%; padding: 10px; background-color: #9D4EDD; color: white; border: none;
            border-radius: 5px; font-size: 14px; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s; margin-top: 10px;
        }
        .apply-op-btn:hover { background-color: #8b3dcf; }
        .status-message { text-align: center; color: #a095c0; font-size: 14px; margin-top: 15px; }

        /* Checklist Styles */
        .checklist-container { max-height: 150px; overflow-y: auto; border: 1px solid #4a3f6e; background-color: #2C2541; border-radius: 5px; padding: 10px; }
        .checklist-item { display: flex; align-items: center; margin-bottom: 8px; }
        .checklist-item input { width: 16px; height: 16px; margin-right: 10px; }
        .checklist-item label { color: #E0D9F0; font-weight: normal; }
        .inline-checkbox { display: flex; align-items: center; margin-top: 10px; }
        .inline-checkbox input { width: 16px; height: 16px; margin-right: 8px; }
        .inline-checkbox label { font-size: 14px; color: #a095c0; font-weight: normal; }
        
        /* Table Styles */
        .table-wrapper { flex-grow: 1; overflow: auto; background-color: #2C2541; border-radius: 8px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { padding: 12px 15px; text-align: left; border-bottom: 2px solid #9D4EDD; background-color: #1E192B; position: sticky; top: 0; }
        .data-table td { padding: 8px 15px; border-bottom: 1px solid #1E192B; }
        .data-table tr:hover { background-color: #4a3f6e; }
    </style>
{% endblock %}

{% block content %}
<div class="columns-layout">
    <aside class="operations-sidebar">
        <!-- Top: Structure Ops -->
        <div class="sidebar-top">
            <h4>Structure</h4>
            <div class="structure-ops">
                <button class="op-btn active" data-op="rename"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>Rename</button>
                <button class="op-btn" data-op="merge"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8L22 12L18 16"></path><path d="M2 12H22"></path><path d="M6 8L2 12L6 16"></path></svg>Merge</button>
                <button class="op-btn" data-op="split"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="18" x2="18" y2="6"></line><line x1="6" y1="6" x2="6" y2="18"></line><line x1="12" y1="12" x2="12" y2="12"></line><path d="M12 12L12 6"></path><path d="M12 18L12 12"></path><path d="M12 12L18 12"></path><path d="M6 12L12 12"></path></svg>Split</button>
                <button class="op-btn" data-op="drop"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>Drop</button>
            </div>
        </div>

        <!-- Bottom: Operation Controls -->
        <div class="sidebar-bottom" id="operation-controls-container">
            <!-- Controls will be rendered here by JavaScript -->
        </div>
    </aside>

    <!-- Main Content: Just the Table -->
    <main class="columns-main">
        <div class="operation-header" id="operation-header">
            <!-- Title will be updated by JS -->
        </div>
        <div class="table-wrapper">
            <table class="data-table">
                <thead id="main-table-head"></thead>
                <tbody id="main-table-body"></tbody>
            </table>
        </div>
    </main>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const opButtons = document.querySelectorAll('.op-btn');
        const header = document.getElementById('operation-header');
        const mainTableHead = document.getElementById('main-table-head');
        const mainTableBody = document.getElementById('main-table-body');
        let columnsWithTypes = [];

        const opDetails = {
            rename: { title: "Rename Column", desc: "Select a column and provide a new name." },
            merge: { title: "Merge Columns", desc: "Combine multiple columns into a single new column." },
            split: { title: "Split Column", desc: "Split a text column into multiple new columns based on a delimiter." },
            drop: { title: "Drop Columns", desc: "Select one or more columns to permanently remove." }
        };

        async function updateMainTable() {
            mainTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 40px; color: #a095c0;">Loading data...</td></tr>`;
            try {
                // The /get_table_body route now returns headers
                const response = await fetch('/get_table_body', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                // --- THE FIX IS HERE: Re-render the header row ---
                mainTableHead.innerHTML = `<tr>${data.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
                
                mainTableBody.innerHTML = data.rows.map(row => `<tr>${row.map(cell => `<td>${cell !== null ? cell : ''}</td>`).join('')}</tr>`).join('');
            } catch (error) {
                mainTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 40px; color: #ffc107;">Error: ${error.message}</td></tr>`;
            }
        }
        
        async function initializeView() {
            try {
                const response = await fetch('/get_schema_details');
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                columnsWithTypes = data.columns;
                // Initially, render the controls for the default active operation ('rename')
                const activeOp = document.querySelector('.op-btn.active').dataset.op;
                header.innerHTML = `<h2>${opDetails[activeOp].title}</h2><p>${opDetails[activeOp].desc}</p>`;
                renderOperationControls(activeOp);
                await updateMainTable();
            } catch (error) {
                console.error("Initialization failed:", error);
            }
        }

        opButtons.forEach(button => {
            button.addEventListener('click', () => {
                opButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const op = button.dataset.op;
                header.innerHTML = `<h2>${opDetails[op].title}</h2><p>${opDetails[op].desc}</p>`;
                renderOperationControls(op);
            });
        });

        function renderOperationControls(operation) {
            const controlsContainer = document.getElementById('operation-controls-container');
            let controlsHtml = '';
            const allColumnOptions = columnsWithTypes.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            const categoricalColumnOptions = columnsWithTypes.filter(c => c.type.includes('VARCHAR')).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            const allColumnChecklist = columnsWithTypes.map(c => `<div class="checklist-item"><input type="checkbox" id="${operation}-col-${c.name}" name="${operation}_cols" value="${c.name}"><label for="${operation}-col-${c.name}">${c.name}</label></div>`).join('');

            if (operation === 'rename') {
                controlsHtml = `<h4>Rename Column</h4><div class="control-group"><label for="rename-select-old">Column to Rename</label><select id="rename-select-old">${allColumnOptions}</select></div><div class="control-group"><label for="rename-input-new">New Name</label><input type="text" id="rename-input-new" placeholder="Enter new name"></div><button id="apply-rename-btn" class="apply-op-btn">Apply Rename</button><div id="op-status" class="status-message"></div>`;
            } else if (operation === 'merge') {
                controlsHtml = `<h4>Merge Columns</h4><div class="control-group"><label>Columns to Merge (select 2+)</label><div class="checklist-container">${allColumnChecklist}</div></div><div class="control-group"><label for="merge-separator">Separator</label><input type="text" id="merge-separator" value=" "></div><div class="control-group"><label for="merge-new-name">New Column Name</label><input type="text" id="merge-new-name" placeholder="e.g., Full_Name"><div class="inline-checkbox"><input type="checkbox" id="merge-drop-originals"><label for="merge-drop-originals">Drop originals</label></div></div><button id="apply-merge-btn" class="apply-op-btn">Apply Merge</button><div id="op-status" class="status-message"></div>`;
            } else if (operation === 'split') {
                controlsHtml = `<h4>Split Column</h4><div class="control-group"><label for="split-select-col">Column to Split (Text only)</label><select id="split-select-col">${categoricalColumnOptions}</select></div><div class="control-group"><label for="split-delimiter">Delimiter</label><input type="text" id="split-delimiter" value=" "></div><div class="control-group"><label for="split-new-names">New Names (comma-separated)</label><input type="text" id="split-new-names" placeholder="e.g., FirstName, LastName"><div class="inline-checkbox"><input type="checkbox" id="split-drop-original"><label for="split-drop-original">Drop original</label></div></div><button id="apply-split-btn" class="apply-op-btn">Apply Split</button><div id="op-status" class="status-message"></div>`;
            } else if (operation === 'drop') {
                controlsHtml = `<h4>Drop Columns</h4><div class="control-group"><label>Columns to Drop</label><div class="checklist-container">${allColumnChecklist}</div></div><button id="apply-drop-btn" class="apply-op-btn" style="background-color: #dc3545;">Apply Drop</button><div id="op-status" class="status-message"></div>`;
            }
            
            controlsContainer.innerHTML = controlsHtml;
            addOperationListeners(operation);
        }

        function addOperationListeners(operation) {
            if (operation === 'rename') {
                const btn = document.getElementById('apply-rename-btn'), status = document.getElementById('op-status');
                btn.addEventListener('click', async () => {
                    const oldName = document.getElementById('rename-select-old').value;
                    const newName = document.getElementById('rename-input-new').value;
                    status.textContent = 'Processing...'; status.style.color = '#a095c0';
                    try {
                        const res = await fetch('/rename_column', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ old_name: oldName, new_name: newName }) });
                        const result = await res.json(); if (result.error) throw new Error(result.error);
                        status.textContent = result.message; status.style.color = '#28a745';
                        await initializeView();
                    } catch (error) { status.textContent = `Error: ${error.message}`; status.style.color = '#dc3545'; }
                });
            } else if (operation === 'merge') {
                const btn = document.getElementById('apply-merge-btn'), status = document.getElementById('op-status');
                btn.addEventListener('click', async () => {
                    const cols = Array.from(document.querySelectorAll('input[name="merge_cols"]:checked')).map(cb => cb.value);
                    const newName = document.getElementById('merge-new-name').value;
                    const sep = document.getElementById('merge-separator').value;
                    const drop = document.getElementById('merge-drop-originals').checked;
                    status.textContent = 'Processing...'; status.style.color = '#a095c0';
                    try {
                        const res = await fetch('/merge_columns', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columns_to_merge: cols, new_column_name: newName, separator: sep, drop_originals: drop }) });
                        const result = await res.json(); if (result.error) throw new Error(result.error);
                        status.textContent = result.message; status.style.color = '#28a745';
                        await initializeView();
                    } catch (error) { status.textContent = `Error: ${error.message}`; status.style.color = '#dc3545'; }
                });
            } else if (operation === 'split') {
                const btn = document.getElementById('apply-split-btn'), status = document.getElementById('op-status');
                btn.addEventListener('click', async () => {
                    const col = document.getElementById('split-select-col').value;
                    const delim = document.getElementById('split-delimiter').value;
                    const newNames = document.getElementById('split-new-names').value;
                    const drop = document.getElementById('split-drop-original').checked;
                    status.textContent = 'Processing...'; status.style.color = '#a095c0';
                    try {
                        const res = await fetch('/split_column', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ column_to_split: col, delimiter: delim, new_column_names: newNames, drop_original: drop }) });
                        const result = await res.json(); if (result.error) throw new Error(result.error);
                        status.textContent = result.message; status.style.color = '#28a745';
                        await initializeView();
                    } catch (error) { status.textContent = `Error: ${error.message}`; status.style.color = '#dc3545'; }
                });
            } else if (operation === 'drop') {
                const btn = document.getElementById('apply-drop-btn'), status = document.getElementById('op-status');
                btn.addEventListener('click', async () => {
                    const cols = Array.from(document.querySelectorAll('input[name="drop_cols"]:checked')).map(cb => cb.value);
                    if (cols.length > 0 && !confirm(`Are you sure you want to permanently delete ${cols.length} column(s)?`)) return;
                    status.textContent = 'Processing...'; status.style.color = '#a095c0';
                    try {
                        const res = await fetch('/drop_columns', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columns_to_drop: cols }) });
                        const result = await res.json(); if (result.error) throw new Error(result.error);
                        status.textContent = result.message; status.style.color = '#28a745';
                        await initializeView();
                    } catch (error) { status.textContent = `Error: ${error.message}`; status.style.color = '#dc3545'; }
                });
            }
        }

        initializeView();
    });
</script>
{% endblock %}